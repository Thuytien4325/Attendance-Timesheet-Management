<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng k√Ω Face ID - Debug</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 50px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        video {
            border: 3px solid #667eea;
            border-radius: 15px;
            background: #000;
            max-width: 100%;
        }
        #debugInfo {
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">üì∏ ƒêƒÉng k√Ω Face ID - Ch·∫ø ƒë·ªô Debug</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-7">
                                <div class="alert alert-info">
                                    <strong>H∆∞·ªõng d·∫´n:</strong>
                                    <ul class="mb-0 small">
                                        <li>ƒê·∫£m b·∫£o √°nh s√°ng ƒë·ªß s√°ng</li>
                                        <li>Nh√¨n th·∫≥ng v√†o camera</li>
                                        <li>Ch·ªâ c√≥ 1 khu√¥n m·∫∑t trong khung h√¨nh</li>
                                    </ul>
                                </div>

                                <div class="text-center">
                                    <video id="video" width="100%" height="400" autoplay></video>
                                    <canvas id="canvas" style="display:none;"></canvas>
                                </div>

                                <div class="text-center mt-3">
                                    <button id="captureBtn" class="btn btn-success btn-lg">
                                        <i class="bi bi-camera"></i> Ch·ª•p ·∫£nh ƒëƒÉng k√Ω
                                    </button>
                                    <a href="/dashboard" class="btn btn-secondary btn-lg">
                                        <i class="bi bi-arrow-left"></i> Quay l·∫°i
                                    </a>
                                </div>

                                <div id="result" class="mt-3"></div>
                            </div>

                            <div class="col-md-5">
                                <div class="card bg-dark text-white">
                                    <div class="card-header">üîç Th√¥ng tin Debug</div>
                                    <div class="card-body" id="debugInfo">
                                        <p>ƒêang kh·ªüi ƒë·ªông...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const resultDiv = document.getElementById('result');
        const debugDiv = document.getElementById('debugInfo');

        function addDebug(msg) {
            const time = new Date().toLocaleTimeString();
            debugDiv.innerHTML += `<p class="mb-1">[${time}] ${msg}</p>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        // Kh·ªüi ƒë·ªông webcam v·ªõi nhi·ªÅu options
        addDebug('üé• ƒêang y√™u c·∫ßu quy·ªÅn truy c·∫≠p webcam...');
        
        navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            }
        })
        .then(stream => {
            video.srcObject = stream;
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            
            addDebug(`‚úÖ Webcam k·∫øt n·ªëi th√†nh c√¥ng!`);
            addDebug(`üìπ ƒê·ªô ph√¢n gi·∫£i: ${settings.width}x${settings.height}`);
            addDebug(`üìπ Frame rate: ${settings.frameRate} fps`);
            addDebug(`üìπ Device: ${track.label}`);
        })
        .catch(err => {
            addDebug(`‚ùå L·ªói webcam: ${err.message}`);
            resultDiv.innerHTML = '<div class="alert alert-danger">Kh√¥ng th·ªÉ truy c·∫≠p webcam: ' + err.message + '</div>';
        });

        captureBtn.addEventListener('click', async () => {
            addDebug('üì∏ B·∫Øt ƒë·∫ßu ch·ª•p ·∫£nh...');
            
            // V·∫Ω ·∫£nh t·ª´ video l√™n canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            addDebug(`üñºÔ∏è K√≠ch th∆∞·ªõc canvas: ${canvas.width}x${canvas.height}`);
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Th·ª≠ nhi·ªÅu ƒë·ªãnh d·∫°ng
            const formats = [
                { type: 'image/jpeg', quality: 0.95, name: 'JPEG (0.95)' },
                { type: 'image/jpeg', quality: 1.0, name: 'JPEG (1.0)' },
                { type: 'image/png', quality: 1.0, name: 'PNG' },
                { type: 'image/webp', quality: 0.95, name: 'WebP' }
            ];

            let imageData = null;
            let formatUsed = null;

            for (let fmt of formats) {
                try {
                    const data = canvas.toDataURL(fmt.type, fmt.quality);
                    if (data && data.startsWith('data:image')) {
                        imageData = data;
                        formatUsed = fmt.name;
                        addDebug(`‚úÖ ƒê·ªãnh d·∫°ng ${fmt.name}: OK (${(data.length/1024).toFixed(1)} KB)`);
                        break;
                    }
                } catch (e) {
                    addDebug(`‚ùå ƒê·ªãnh d·∫°ng ${fmt.name}: L·ªói - ${e.message}`);
                }
            }

            if (!imageData) {
                addDebug('‚ùå Kh√¥ng th·ªÉ chuy·ªÉn ƒë·ªïi ·∫£nh sang b·∫•t k·ª≥ ƒë·ªãnh d·∫°ng n√†o!');
                resultDiv.innerHTML = '<div class="alert alert-danger">L·ªói: Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh t·ª´ webcam</div>';
                return;
            }

            addDebug(`üì¶ S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng: ${formatUsed}`);
            addDebug(`üì§ ƒêang g·ª≠i ·∫£nh l√™n server...`);

            // Hi·ªÉn th·ªã loading
            captureBtn.disabled = true;
            captureBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';
            resultDiv.innerHTML = '<div class="alert alert-warning">ƒêang ph√¢n t√≠ch khu√¥n m·∫∑t...</div>';

            try {
                const response = await fetch('/register-face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                addDebug(`üì• Server ph·∫£n h·ªìi: HTTP ${response.status}`);

                const data = await response.json();
                addDebug(`üìã K·∫øt qu·∫£: ${JSON.stringify(data)}`);

                if (data.success) {
                    addDebug('‚úÖ TH√ÄNH C√îNG!');
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ ${data.message}</strong>
                            <p class="mb-0 mt-2">B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng Face ID ƒë·ªÉ ch·∫•m c√¥ng ngay b√¢y gi·ªù!</p>
                        </div>`;
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 2000);
                } else {
                    addDebug(`‚ùå L·ªói: ${data.message}`);
                    resultDiv.innerHTML = `<div class="alert alert-danger"><strong>‚ùå ${data.message}</strong></div>`;
                    captureBtn.disabled = false;
                    captureBtn.innerHTML = '<i class="bi bi-camera"></i> Ch·ª•p l·∫°i';
                }
            } catch (error) {
                addDebug(`‚ùå L·ªói k·∫øt n·ªëi: ${error.message}`);
                resultDiv.innerHTML = `<div class="alert alert-danger">L·ªói k·∫øt n·ªëi: ${error.message}</div>`;
                captureBtn.disabled = false;
                captureBtn.innerHTML = '<i class="bi bi-camera"></i> Ch·ª•p l·∫°i';
            }
        });
    </script>
</body>
</html>