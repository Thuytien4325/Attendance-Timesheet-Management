<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√°y Qu√©t Ch·∫•m C√¥ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background-color: #000; color: white; height: 100vh; display: flex; flex-direction: column; }
        .scanner-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #reader { width: 100%; max-width: 500px; border-radius: 12px; overflow: hidden; border: 2px solid #0d6efd; background: #222; }
        
        /* Ch·ªânh giao di·ªán v√πng qu√©t */
        #reader video { object-fit: cover; border-radius: 12px; }
        
        .result-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; align-items: center; justify-content: center; text-align: center;
        }
        .scan-line { width: 100%; height: 2px; background: red; position: absolute; top: 50%; animation: scan 2s infinite; opacity: 0.6; }
        @keyframes scan { 0% {top: 10%} 50% {top: 90%} 100% {top: 10%} }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between align-items-center p-3 bg-dark border-bottom border-secondary">
        <a href="/dashboard" class="btn btn-outline-light btn-sm">üîô Tho√°t</a>
        <span class="fw-bold">üì∑ M√ÅY QU√âT</span>
        <button class="btn btn-sm btn-primary" onclick="switchMode()">üìÇ Upload</button>
    </div>

    <div class="scanner-wrapper p-3">
        <div id="camera-mode" class="w-100 text-center">
            <div id="reader"></div>
            <p class="mt-3 text-white-50 small">ƒê∆∞a m√£ QR v√†o khung h√¨nh</p>
        </div>

        <div id="upload-mode" class="w-100 text-center" style="display: none;">
            <div class="card bg-dark text-white border-secondary p-4 mx-auto" style="max-width: 400px;">
                <h5>T·∫£i ·∫£nh QR l√™n</h5>
                <p class="text-muted small">D√πng khi camera b·ªã l·ªói ho·∫∑c test tr√™n PC</p>
                <input type="file" class="form-control mb-3" id="qr-input-file" accept="image/*">
                <div id="file-status" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div id="result-overlay" class="result-overlay" onclick="closeOverlay()">
        <div class="p-4 bg-white text-dark rounded-4 shadow-lg" style="width: 90%; max-width: 400px;">
            <div id="res-icon" class="display-1 mb-2">‚úÖ</div>
            <h3 id="res-title" class="fw-bold">Th√†nh c√¥ng!</h3>
            <p id="res-msg" class="fs-5">ƒê√£ ch·∫•m c√¥ng cho Nguy·ªÖn VƒÉn A</p>
            <p class="text-muted small">Ch·∫°m v√†o m√†n h√¨nh ƒë·ªÉ ti·∫øp t·ª•c qu√©t...</p>
        </div>
    </div>

    <audio id="beep" src="https://www.soundjay.com/button/beep-07.wav"></audio>

    <script>
        let html5QrcodeScanner;
        const resultOverlay = document.getElementById('result-overlay');
        const beepAudio = document.getElementById('beep');
        let isProcessing = false;

        function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return; // Ch·∫∑n qu√©t li√™n t·ª•c
            isProcessing = true;
            beepAudio.play();

            // G·ª≠i d·ªØ li·ªáu v·ªÅ server
            fetch('/scan-checkin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ qr_data: decodedText })
            })
            .then(res => res.json())
            .then(data => {
                showResult(data);
            })
            .catch(err => {
                showResult({success: false, message: "L·ªói k·∫øt n·ªëi Server!"});
            });
        }

        function showResult(data) {
            const icon = document.getElementById('res-icon');
            const title = document.getElementById('res-title');
            const msg = document.getElementById('res-msg');

            resultOverlay.style.display = 'flex';
            
            if (data.success) {
                icon.innerHTML = '‚úÖ';
                title.innerText = "TH√ÄNH C√îNG";
                title.className = "fw-bold text-success";
                msg.innerHTML = `<b>${data.message}</b><br>‚è∞ ${data.time}`;
            } else {
                icon.innerHTML = '‚ùå';
                title.innerText = "TH·∫§T B·∫†I";
                title.className = "fw-bold text-danger";
                msg.innerText = data.message;
            }
        }

        function closeOverlay() {
            resultOverlay.style.display = 'none';
            // T·∫°m d·ª´ng 2 gi√¢y tr∆∞·ªõc khi cho ph√©p qu√©t ti·∫øp ƒë·ªÉ tr√°nh nh·∫ßm
            setTimeout(() => { isProcessing = false; }, 1000);
        }

        // C·∫•u h√¨nh Camera
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            showTorchButtonIfSupported: true 
        });
        html5QrcodeScanner.render(onScanSuccess);

        // --- X·ª¨ L√ù CH·∫æ ƒê·ªò UPLOAD ·∫¢NH ---
        function switchMode() {
            const cam = document.getElementById('camera-mode');
            const up = document.getElementById('upload-mode');
            if (cam.style.display === 'none') {
                cam.style.display = 'block'; up.style.display = 'none';
            } else {
                cam.style.display = 'none'; up.style.display = 'block';
            }
        }

        const html5QrCodeFile = new Html5Qrcode("reader");
        document.getElementById('qr-input-file').addEventListener('change', e => {
            if (e.target.files.length == 0) return;
            const imageFile = e.target.files[0];
            html5QrCodeFile.scanFile(imageFile, true)
            .then(decodedText => { onScanSuccess(decodedText); })
            .catch(err => { alert("Kh√¥ng t√¨m th·∫•y m√£ QR trong ·∫£nh!"); });
        });
    </script>
</body>
</html>