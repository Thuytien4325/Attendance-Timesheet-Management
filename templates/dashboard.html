<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Hệ thống Chấm Công</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .chart-box { position: relative; height: 300px; width: 100%; display: flex; align-items: center; justify-content: center; }
        .empty-data-msg { color: #aaa; font-style: italic; position: absolute; display: none; }
        .status-badge { font-size: 0.8rem; padding: 0.3em 0.6em; border-radius: 10rem; }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    <div class="container-fluid p-0">
        <div class="row g-0">
            <div class="col-md-3 col-lg-2" id="sidebar">
                <div class="d-flex flex-column h-100">
                    <div class="logo-section text-center p-3">
                        <div class="logo-icon fs-1 mb-2"><i class="bi bi-clock-history"></i></div>
                        <h4 class="fw-bold">TimeKeeper</h4>
                    </div>
                    
                    <nav class="mt-4 flex-grow-1 px-2">
                        <a href="{{ url_for('dashboard') }}" class="menu-item active d-block p-2 rounded mb-1 text-decoration-none text-white bg-primary">
                            <i class="bi bi-house-door-fill me-2"></i><span>Trang chủ</span>
                        </a>
                        <a href="#history" class="menu-item d-block p-2 rounded mb-1 text-decoration-none text-white-50">
                            <i class="bi bi-calendar-check me-2"></i><span>Lịch sử</span>
                        </a>
                        
                        {% if session.get('role') == 'admin' %}
                        <div class="mt-3 mb-2 px-2 text-uppercase text-white-50 small fw-bold">Quản trị</div>
                        <a href="{{ url_for('admin_users') }}" class="menu-item d-block p-2 rounded mb-1 text-decoration-none text-white-50">
                            <i class="bi bi-people-fill me-2"></i><span>Quản lý NV</span>
                        </a>
                        <a href="{{ url_for('admin_roster') }}" class="menu-item d-block p-2 rounded mb-1 text-decoration-none text-white-50">
                            <i class="bi bi-calendar-week me-2"></i><span>Xếp Lịch Làm Việc</span>
                        </a>
                        <a href="{{ url_for('admin_approvals') }}" class="menu-item d-block p-2 rounded mb-1 text-decoration-none text-white-50">
                            <i class="bi bi-check2-square me-2"></i><span>Phê duyệt công</span>
                        </a>
                        <a href="{{ url_for('export_attendance') }}" class="menu-item d-block p-2 rounded mb-1 text-decoration-none text-white-50">
                            <i class="bi bi-file-earmark-excel-fill me-2"></i><span>Xuất Báo Cáo</span>
                        </a>
                        {% endif %}
                    </nav>

                    <div class="p-3 border-top border-secondary">
                        <h6 class="text-white-50 small text-uppercase mb-2 fw-bold">Tiện ích</h6>
                        <a href="{{ url_for('my_qr') }}" class="btn btn-outline-light w-100 mb-2 btn-sm text-start"><i class="bi bi-qr-code me-2"></i> Mã QR</a>
                        <a href="/register-face" class="btn btn-info w-100 mb-2 btn-sm text-start text-white"><i class="bi bi-person-bounding-box me-2"></i> Đăng ký Face</a>
                        <a href="{{ url_for('logout') }}" class="btn btn-danger w-100 btn-sm mt-3 text-start"><i class="bi bi-box-arrow-right me-2"></i> Đăng xuất</a>
                    </div>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 bg-light">
                <div class="main-content p-4">
                    <nav class="navbar navbar-light bg-white rounded-3 shadow-sm mb-4 px-3 py-2">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <button class="btn d-md-none" id="sidebarToggle"><i class="bi bi-list fs-4"></i></button>
                            
                            <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#requestModal">
                                <i class="bi bi-file-earmark-plus-fill me-2"></i> Gửi Yêu Cầu / Xin Nghỉ
                            </button>

                            <div class="d-flex align-items-center gap-3">
                                <div class="text-end">
                                    <small class="text-muted d-block">Xin chào,</small>
                                    <strong class="text-dark">{{ session.get('name', 'Nhân viên') }}</strong>
                                </div>
                                <div class="bg-light px-3 py-1 rounded border text-center">
                                    <small class="text-muted d-block" style="font-size: 0.7rem;">CA HÔM NAY</small>
                                    <strong class="text-primary">
                                        {% if today_shift %}
                                            {{ today_shift.shift_name }} <br>
                                            <small class="text-dark">({{ today_shift.start_time.strftime('%H:%M') }} - {{ today_shift.end_time.strftime('%H:%M') }})</small>
                                        {% else %}
                                            <span class="text-danger">OFF (Nghỉ)</span>
                                        {% endif %}
                                    </strong>
                                </div>
                            </div>
                        </div>
                    </nav>

                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="row g-4 mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100 bg-primary text-white text-center p-4 rounded-4">
                                <div class="clock-display display-4 fw-bold" id="clock">00:00:00</div>
                                <div class="fs-5 opacity-75" id="date">...</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm h-100 p-4 rounded-4 text-center">
                                <h4 class="mb-3 text-secondary fw-bold">Chấm Công Hôm Nay</h4>
                                {% if attendance_today %}
                                    <div class="alert alert-success d-inline-block px-4 py-2 rounded-pill mb-3">
                                        Đã chấm: <strong>{{ attendance_today.status }}</strong> lúc {{ attendance_today.check_in_time.strftime('%H:%M') }}
                                        {% if attendance_today.overtime_minutes > 0 %}
                                            <br><small>(Tăng ca: {{ attendance_today.overtime_minutes }} phút)</small>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <p class="text-muted fst-italic mb-3">Chưa có dữ liệu chấm công.</p>
                                {% endif %}
                                
                                <div class="d-flex justify-content-center gap-3">
                                    <form action="{{ url_for('checkin') }}" method="POST">
                                        <button class="btn btn-success btn-lg rounded-pill px-5 shadow-sm" {% if attendance_today %}disabled{% endif %}>
                                            <i class="bi bi-box-arrow-in-right me-2"></i>VÀO CA
                                        </button>
                                    </form>
                                    <form action="{{ url_for('checkout') }}" method="POST">
                                        <button class="btn btn-warning btn-lg rounded-pill px-5 text-white shadow-sm" {% if not attendance_today or attendance_today.check_out_time %}disabled{% endif %}>
                                            <i class="bi bi-box-arrow-right me-2"></i>TAN CA
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row row-cols-2 row-cols-md-4 g-3 mb-4">
                        <div class="col"><div class="p-3 bg-white rounded-3 shadow-sm text-center border-bottom border-primary border-4"><h3>{{ stats.total }}</h3><small class="text-muted">Tổng ngày</small></div></div>
                        <div class="col"><div class="p-3 bg-white rounded-3 shadow-sm text-center border-bottom border-success border-4"><h3>{{ stats.on_time }}</h3><small class="text-muted">Đúng giờ</small></div></div>
                        <div class="col"><div class="p-3 bg-white rounded-3 shadow-sm text-center border-bottom border-danger border-4"><h3>{{ stats.late }}</h3><small class="text-muted">Đi muộn</small></div></div>
                        <div class="col"><div class="p-3 bg-white rounded-3 shadow-sm text-center border-bottom border-warning border-4"><h3>{{ stats.early }}</h3><small class="text-muted">Về sớm</small></div></div>
                    </div>

                    {% if session.get('role') == 'admin' %}
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm rounded-4 h-100">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary">Tỷ lệ hôm nay</h6>
                                    <div class="chart-box">
                                        <canvas id="pieChart"></canvas>
                                        <div id="pieMsg" class="empty-data-msg">Chưa có dữ liệu</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm rounded-4 h-100">
                                <div class="card-body">
                                    <h6 class="fw-bold text-secondary">Xu hướng tuần qua</h6>
                                    <div class="chart-box"><canvas id="barChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="card border-0 shadow-sm rounded-4" id="history">
                        <div class="card-header bg-white py-3">
                            <h5 class="fw-bold text-primary mb-0"><i class="bi bi-clock-history me-2"></i>Lịch Sử Chấm Công</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-4">#</th>
                                            {% if session.get('role') == 'admin' %}<th>Nhân viên</th>{% endif %}
                                            <th>Ngày</th>
                                            <th>Giờ Vào</th>
                                            <th>Giờ Ra</th>
                                            <th>Trạng thái</th>
                                            <th>Phê duyệt</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in data %}
                                        <tr>
                                            <td class="ps-4 text-muted">{{ loop.index }}</td>
                                            {% if session.get('role') == 'admin' %}<td><strong>{{ row.full_name }}</strong></td>{% endif %}
                                            <td>{{ row.date }}</td>
                                            <td class="text-success fw-bold">{{ row.check_in }}</td>
                                            <td class="text-warning fw-bold">{{ row.check_out }}</td>
                                            <td><span class="badge {{ row.css_class }} rounded-pill">{{ row.status }}</span></td>
                                            <td>
                                                <span class="{{ row.approval_css }} fw-bold small">{{ row.approval }}</span>
                                                {% if row.notes %}
                                                    <br><small class="text-muted fst-italic" style="font-size: 0.75rem;">"{{ row.notes }}"</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if (row.status != 'Đúng giờ' and row.approval != 'Approved') %}
                                                    <button class="btn btn-outline-primary btn-sm py-0 px-2" 
                                                            onclick="openExplainModal('{{ row.id }}')">
                                                        <i class="bi bi-pencil-square"></i> Giải trình
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr><td colspan="8" class="text-center py-4 text-muted">Chưa có dữ liệu</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="explainModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-send-exclamation me-2"></i>Gửi Giải Trình</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ url_for('submit_explanation') }}" method="POST">
                    <div class="modal-body p-4">
                        <input type="hidden" name="attendance_id" id="explain_att_id">
                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary">Lý do giải trình:</label>
                            <textarea name="reason" class="form-control" rows="4" required 
                                      placeholder="Ví dụ: Tắc đường do tai nạn, Xe hỏng, Xin phép về sớm..."></textarea>
                            <div class="form-text">Lý do này sẽ được gửi đến Quản lý để phê duyệt.</div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary px-4"><i class="bi bi-send me-2"></i>Gửi đi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-plus me-2"></i>Tạo Yêu Cầu Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form action="{{ url_for('submit_explanation') }}" method="POST">
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Chọn ngày:</label>
                            <input type="date" name="target_date" id="request_date" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nội dung yêu cầu:</label>
                            <textarea name="reason" class="form-control" rows="4" required 
                                placeholder="Ví dụ: Xin nghỉ phép hôm nay, Quên chấm công sáng nay..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-success px-4">Gửi Yêu Cầu</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 1. Đồng hồ
        function updateClock() {
            const now = new Date();
            if(document.getElementById('clock')) 
                document.getElementById('clock').innerText = now.toLocaleTimeString('vi-VN', {hour12: false});
            if(document.getElementById('date')) 
                document.getElementById('date').innerText = now.toLocaleDateString('vi-VN', {weekday: 'long', year: 'numeric', month: 'numeric', day: 'numeric'});
        }
        setInterval(updateClock, 1000); updateClock();

        // 2. Tự điền ngày hôm nay vào Modal Request
        document.getElementById('request_date').valueAsDate = new Date();

        // 3. Mở Modal Giải Trình
        function openExplainModal(id) {
            document.getElementById('explain_att_id').value = id;
            new bootstrap.Modal(document.getElementById('explainModal')).show();
        }

        // 4. Vẽ Biểu đồ (ChartJS)
        document.addEventListener('DOMContentLoaded', function() {
            const pieCanvas = document.getElementById('pieChart');
            const barCanvas = document.getElementById('barChart');

            if (pieCanvas && barCanvas) {
                fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    if(data.success) {
                        const totalPie = data.pie.on_time + data.pie.late + data.pie.early;
                        if (totalPie === 0) {
                            pieCanvas.style.display = 'none';
                            document.getElementById('pieMsg').style.display = 'block';
                        } else {
                            new Chart(pieCanvas, {
                                type: 'doughnut',
                                data: {
                                    labels: ['Đúng giờ', 'Đi muộn', 'Về sớm'],
                                    datasets: [{
                                        data: [data.pie.on_time, data.pie.late, data.pie.early],
                                        backgroundColor: ['#198754', '#dc3545', '#ffc107'],
                                        borderWidth: 0
                                    }]
                                },
                                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                            });
                        }

                        new Chart(barCanvas, {
                            type: 'bar',
                            data: {
                                labels: data.bar.labels,
                                datasets: [{
                                    label: 'Số lượt chấm công',
                                    data: data.bar.data,
                                    backgroundColor: '#0d6efd',
                                    borderRadius: 4
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                        });
                    }
                });
            }
        });
    </script>
</body>
</html>