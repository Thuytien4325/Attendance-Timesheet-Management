{% extends "layouts/dashboard_base.html" %}

{% block title %}Dashboard - Hệ thống Chấm Công{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="welcome-card">
        <div class="clock-display" id="clock">00:00:00</div>
        <div class="date-display" id="date">Đang tải dữ liệu...</div>
    </div>

    <div class="checkin-section">
        <div class="current-time text-muted mb-2" id="currentTime"><i class="fas fa-clock"></i> --:--:--</div>
        <h4 class="mb-4 fw-bold" style="color: #667eea;">Chấm Công Hôm Nay</h4>
        <div class="action-buttons">
            <form action="{{ url_for('checkin') }}" method="POST">
                <button class="btn btn-success btn-action"><i class="fas fa-sign-in-alt me-2"></i> VÀO CA</button>
            </form>
            <form action="{{ url_for('checkout') }}" method="POST">
                <button class="btn btn-warning btn-action"><i class="fas fa-sign-out-alt me-2"></i> TAN CA</button>
            </form>
            <button id="btn-qr-scan" class="btn btn-primary btn-action"><i class="fas fa-qrcode me-2"></i> QUÉT QR</button>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal fade" id="qrScannerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-qrcode me-2" style="color: #667eea;"></i>Quét Mã QR Chấm Công</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <video id="qr-video" style="width: 100%; max-width: 400px; height: 300px; border-radius: 8px; object-fit: cover; display: none; background: #000;"></video>
                    <div id="qr-placeholder" style="width: 100%; height: 300px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div style="text-align: center;">
                            <i class="fas fa-camera" style="font-size: 2.5rem; color: #667eea; margin-bottom: 10px;"></i>
                            <p style="color: #999; margin-top: 10px;">Đang khởi động camera...</p>
                        </div>
                    </div>
                    <div id="qr-result" class="alert mt-3" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button id="btn-stop-scan" class="btn btn-secondary" style="display: none;">Dừng Quét</button>
                    <label class="btn btn-outline-primary me-2 mb-0">
                        <i class="fas fa-image me-2"></i>
                        Chọn ảnh
                        <input type="file" id="qr-file-input" accept="image/*" hidden>
                    </label>
                    <button id="qr-upload-btn" class="btn btn-primary">Gửi ảnh</button>
                    <input type="text" id="qr-code-input" class="form-control ms-2" placeholder="Hoặc dán mã QR tại đây..." style="max-width: 250px; display: inline-block;">
                </div>
            </div>
        </div>
    </div>

    <div class="history-card mt-4" id="history">
        <h3 class="mb-4" style="color: #2c3e50;"><i class="fas fa-history me-2"></i> Lịch Sử Chấm Công</h3>
        <div class="table-responsive">
            <table class="table table-hover attendance-table align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ngày làm việc</th>
                        <th>Giờ vào</th>
                        <th>Giờ ra</th>
                        <th>Trạng thái</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                    {% if data %}
                        {% for row in data %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>{{ row.date }}</td>
                            <td><strong class="text-success">{{ row.check_in }}</strong></td>
                            <td><strong class="text-warning">{{ row.check_out }}</strong></td>
                            <td><span class="badge {{ row.css_class }} rounded-pill">{{ row.status }}</span></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr><td colspan="5" class="text-center">Chưa có dữ liệu chấm công</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let isQRScanning = false;
    let videoStream = null;

    const btnQRScan = document.getElementById('btn-qr-scan');
    const qrScannerModal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
    const stopQRScanBtn = document.getElementById('btn-stop-scan');
    const qrResultDiv = document.getElementById('qr-result');
    const qrVideoElement = document.getElementById('qr-video');
    const qrPlaceholder = document.getElementById('qr-placeholder');
    const qrCodeInput = document.getElementById('qr-code-input');

    // Open QR Scanner Modal
    btnQRScan.addEventListener('click', function(e) {
        e.preventDefault();
        qrScannerModal.show();
        startQRScanning();
    });

    // Start QR Scanning
    async function startQRScanning() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' }
            });
            
            videoStream = stream;
            qrVideoElement.srcObject = stream;
            isQRScanning = true;

            qrPlaceholder.style.display = 'none';
            qrVideoElement.style.display = 'block';
            stopQRScanBtn.style.display = 'inline-block';
            qrResultDiv.style.display = 'none';

            scanQRCode();
        } catch (error) {
            qrPlaceholder.innerHTML = '<div style="text-align: center;"><i class="fas fa-camera-slash" style="font-size: 2.5rem; color: #dc3545; margin-bottom: 10px;"></i><p style="color: #dc3545;">Không thể truy cập camera</p><p style="color: #999; font-size: 0.9rem;">' + error.message + '</p></div>';
        }
    }

    // Stop QR Scanning
    stopQRScanBtn.addEventListener('click', function() {
        stopScanning();
    });

    // QR Code Scanning Function
    function scanQRCode() {
        if (!isQRScanning) return;

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        canvas.width = qrVideoElement.videoWidth;
        canvas.height = qrVideoElement.videoHeight;

        if (canvas.width && canvas.height) {
            context.drawImage(qrVideoElement, 0, 0, canvas.width, canvas.height);
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code) {
                processQRCode(code.data);
                return;
            }
        }
        
        requestAnimationFrame(scanQRCode);
    }

    // Process QR Code
    function processQRCode(qrData) {
        console.log('QR Code detected:', qrData);
        
        qrResultDiv.style.display = 'block';
        qrResultDiv.innerHTML = '<strong>✓ Mã QR phát hiện:</strong> ' + qrData;
        qrResultDiv.className = 'alert alert-success';

        stopScanning();
        submitQRCheckInOut(qrData);
    }

    // Stop Scanning Helper
    function stopScanning() {
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
        }
        isQRScanning = false;
        qrVideoElement.srcObject = null;
        
        qrPlaceholder.style.display = 'flex';
        qrPlaceholder.innerHTML = '<div style="text-align: center;"><i class="fas fa-camera" style="font-size: 2.5rem; color: #667eea; margin-bottom: 10px;"></i><p style="color: #999; margin-top: 10px;">Camera đã dừng</p></div>';
        qrVideoElement.style.display = 'none';
        stopQRScanBtn.style.display = 'none';
    }

    // Handle QR Code Input Fallback
    qrCodeInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const qrData = this.value.trim();
            if (qrData) {
                stopScanning();
                processQRCode(qrData);
                this.value = '';
            }
        }
    });

    // Modal close event
    document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function() {
        stopScanning();
        qrResultDiv.style.display = 'none';
        qrCodeInput.value = '';
    });

    // Submit QR Check-in/Check-out via unified AJAX endpoint
    function submitQRCheckInOut(qrData) {
        fetch("{{ url_for('api_qr_checkin') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: qrData })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                qrResultDiv.className = 'alert alert-success';
                const action = data.action || 'Chấm công';
                qrResultDiv.innerHTML = '<strong>✓ ' + action + ' thành công!</strong><br>' + (data.message || '');
                setTimeout(() => {
                    qrScannerModal.hide();
                    location.reload();
                }, 2000);
            } else {
                qrResultDiv.className = 'alert alert-danger';
                qrResultDiv.innerHTML = '<strong>✗ Lỗi:</strong> ' + (data.message || 'Chấm công không thành công');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            qrResultDiv.className = 'alert alert-danger';
            qrResultDiv.innerHTML = '<strong>✗ Lỗi kết nối:</strong> ' + error.message;
        });
    }

    // --- Image upload handling for modal ---
    function showModalStatus(html) {
        qrResultDiv.style.display = 'block';
        qrResultDiv.innerHTML = html;
    }

    async function uploadImageFile(file) {
        if (!file) return;
        // Stop camera scanning while uploading
        stopScanning();

        showModalStatus('<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i> Đang gửi ảnh...</div>');

        const form = new FormData();
        form.append('image', file);

        try {
            const resp = await fetch("{{ url_for('api_qr_checkin_image') }}", {
                method: 'POST',
                body: form
            });
            const data = await resp.json();
            if (resp.ok && data.success) {
                showModalStatus('<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i> ' + data.message + '</div>');
                setTimeout(() => { qrScannerModal.hide(); location.reload(); }, 1500);
            } else {
                showModalStatus('<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i> ' + (data.message || 'Lỗi khi xử lý ảnh') + '</div>');
            }
        } catch (err) {
            console.error(err);
            showModalStatus('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i> Lỗi kết nối server!</div>');
        }
    }

    const fileInput = document.getElementById('qr-file-input');
    const uploadBtn = document.getElementById('qr-upload-btn');

    fileInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) uploadImageFile(f);
    });

    uploadBtn.addEventListener('click', (e) => {
        const f = fileInput.files && fileInput.files[0];
        if (!f) { fileInput.click(); return; }
        uploadImageFile(f);
    });
});
</script>
{% endblock %}