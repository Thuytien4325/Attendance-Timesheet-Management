{% extends "base.html" %}
{% block title %}Face ID Check-in{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-lg">
                <div class="card-header bg-gradient text-white text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h3 class="mb-0">üé≠ Ch·∫•m c√¥ng b·∫±ng Face ID</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <video id="video" width="100%" height="480" autoplay style="border: 3px solid #667eea; border-radius: 15px; background: #000;"></video>
                                <canvas id="canvas" style="display:none;"></canvas>
                                
                                <!-- Overlay h∆∞·ªõng d·∫´n -->
                                <div style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px; color: white;">
                                    <strong>üë§ H√£y nh√¨n th·∫≥ng v√†o camera</strong>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="alert alert-info">
                                <h5>üìã H∆∞·ªõng d·∫´n:</h5>
                                <ul class="small">
                                    <li>ƒê·∫£m b·∫£o √°nh s√°ng ƒë·ªß</li>
                                    <li>Nh√¨n th·∫≥ng v√†o camera</li>
                                    <li>Gi·ªØ khu√¥n m·∫∑t ·ªïn ƒë·ªãnh</li>
                                    <li>H·ªá th·ªëng t·ª± ƒë·ªông qu√©t</li>
                                </ul>
                            </div>

                            <div id="statusBox" class="alert alert-secondary">
                                <strong>Tr·∫°ng th√°i:</strong> <span id="statusText">ƒêang kh·ªüi ƒë·ªông camera...</span>
                            </div>

                            <div id="result"></div>

                            <button id="manualCapture" class="btn btn-primary btn-block mb-2" style="display:none;">
                                <i class="bi bi-camera-fill"></i> Ch·ª•p th·ªß c√¥ng
                            </button>
                            
                            <a href="/dashboard" class="btn btn-secondary btn-block">
                                <i class="bi bi-arrow-left"></i> Quay l·∫°i
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusText = document.getElementById('statusText');
    const statusBox = document.getElementById('statusBox');
    const resultDiv = document.getElementById('result');
    const manualBtn = document.getElementById('manualCapture');

    let isProcessing = false;
    let scanInterval;

    // Kh·ªüi ƒë·ªông webcam
    navigator.mediaDevices.getUserMedia({
        video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
        }
    })
    .then(stream => {
        video.srcObject = stream;
        statusText.textContent = '‚úÖ Camera s·∫µn s√†ng - ƒêang qu√©t khu√¥n m·∫∑t...';
        statusBox.className = 'alert alert-success';
        
        // B·∫≠t n√∫t ch·ª•p th·ªß c√¥ng
        manualBtn.style.display = 'block';
        
        // T·ª± ƒë·ªông qu√©t m·ªói 2 gi√¢y
        scanInterval = setInterval(captureAndCheck, 2000);
    })
    .catch(err => {
        statusText.textContent = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p webcam';
        statusBox.className = 'alert alert-danger';
        resultDiv.innerHTML = `<div class="alert alert-danger">L·ªói: ${err.message}</div>`;
    });

    // H√†m ch·ª•p v√† ki·ªÉm tra Face ID
    async function captureAndCheck() {
        if (isProcessing) return;
        isProcessing = true;

        // V·∫Ω ·∫£nh t·ª´ video l√™n canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);

        // Chuy·ªÉn sang JPEG ƒë·ªÉ ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch
        const imageData = canvas.toDataURL('image/jpeg', 0.95);

        try {
            const response = await fetch('/api/face-checkin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: imageData })
            });

            const data = await response.json();

            if (data.success) {
                // D·ª´ng qu√©t
                clearInterval(scanInterval);
                
                statusText.textContent = '‚úÖ Nh·∫≠n di·ªán th√†nh c√¥ng!';
                statusBox.className = 'alert alert-success';

                resultDiv.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ ${data.message}</h5>
                        <hr>
                        <p class="mb-1"><strong>Th·ªùi gian:</strong> ${data.time}</p>
                        <p class="mb-1"><strong>Tr·∫°ng th√°i:</strong> <span class="badge badge-${data.status_class}">${data.status}</span></p>
                        ${data.confidence ? `<p class="mb-0"><strong>ƒê·ªô tin c·∫≠y:</strong> ${data.confidence}</p>` : ''}
                    </div>`;

                // T·∫Øt video sau 3 gi√¢y
                setTimeout(() => {
                    video.srcObject.getTracks().forEach(track => track.stop());
                    video.style.display = 'none';
                    resultDiv.innerHTML += '<div class="alert alert-info mt-3">ƒêang chuy·ªÉn v·ªÅ trang ch·ªß...</div>';
                    setTimeout(() => window.location.href = '/dashboard', 2000);
                }, 3000);

            } else {
                // Ch·ªâ hi·ªÉn th·ªã l·ªói quan tr·ªçng, b·ªè qua "ƒêang t√¨m khu√¥n m·∫∑t..."
                if (!data.message.includes('ƒêang t√¨m')) {
                    statusText.textContent = data.message;
                    statusBox.className = 'alert alert-warning';
                }
            }
        } catch (error) {
            console.error('L·ªói:', error);
        }

        isProcessing = false;
    }

    // N√∫t ch·ª•p th·ªß c√¥ng
    manualBtn.addEventListener('click', () => {
        clearInterval(scanInterval);
        captureAndCheck();
        setTimeout(() => scanInterval = setInterval(captureAndCheck, 2000), 3000);
    });
</script>

<style>
    .badge-success { background-color: #28a745; color: white; }
    .badge-danger { background-color: #dc3545; color: white; }
</style>
{% endblock %}